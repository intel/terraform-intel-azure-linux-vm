#######

  # The cloud-init script you provided will do the following:
    # Update and upgrade the system packages.
    # Install the git package.
    # Install Ansible using the distro installation method and the ansible package name.
    # Pull the Ansible playbook from the https://github.com/intel/optimized-cloud-recipes.git repository and execute the recipes/sqlite-flask-sgx-ubuntu/gramine.recipe.yml playbook.
 
  # To learn more about Cloud - Init : https://cloudinit.readthedocs.io/en/latest/index.html
#######

#cloud-config
package_update: true
package_upgrade: true

packages:
  - git

write_files:
    - path: /tmp/intel-ita/config.json
      content: |
        {
            "trustauthority_url": "https://portal.trustauthority.intel.com",
            "trustauthority_api_url": "https://api.trustauthority.intel.com",
            "trustauthority_api_key": "${trustauthority_api_key}"
        }
      permissions: '0644'
      create_directories: true

runcmd:
  - apt install git -y
  - apt install software-properties-common -y
  - add-apt-repository --yes --update ppa:ansible/ansible
  - apt install ansible -y
  - export trustauthority_api_key=${trustauthority_api_key}
  - git clone -b dshrestha-azure-linux-tdx-ita https://github.com/intel/optimized-cloud-recipes.git /tmp/optimized-cloud-recipes
  - cd /tmp/optimized-cloud-recipes/recipes/intel-azure-linux-tdx-ita 
  - ansible-playbook recipe.yml

